<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Ink Stock Monitor & CSV Report (Qty) - V7 (Dynamic Buttons)</title>
    <style>
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f6f9; 
            color: #333;
        }
        /* MAIN CONTAINER: Horizontal Flex Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); 
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 25px;
        }
        h1 {
            width: 100%;
            text-align: center;
            color: #1a73e8; 
            margin-bottom: 25px;
            font-size: 2.2em;
            font-weight: 500;
        }
        h2 {
            color: #1a73e8;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: 500;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 5px;
        }
        /* SECTION Styling (Card Effect) */
        .section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            flex-basis: 48%; 
            box-sizing: border-box; 
            min-width: 350px; 
            transition: transform 0.2s;
        }
        .section:hover {
            transform: translateY(-2px); 
        }
        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #f0f0f0;
            text-align: left;
            font-size: 0.95em;
        }
        th {
            background-color: #1a73e8; 
            color: white;
            text-transform: uppercase;
            font-weight: 400;
        }
        .low-stock {
            background-color: #fdd8d8 !important; 
            color: #c0392b;
            font-weight: bold;
        }
        /* Input Field Styling */
        input[type="number"], input[type="date"], select, input[type="text"] {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 5px;
            transition: border-color 0.2s;
            flex-grow: 1;
        }
        input:focus, select:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
            outline: none;
        }
        /* Button Styling */
        .action-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95em;
            transition: background-color 0.2s, transform 0.1s;
        }
        .action-btn:active {
            transform: scale(0.98);
        }

        .add-btn { background-color: #34a853; color: white; } 
        .add-btn:hover { background-color: #2c8c46; }

        .use-btn { background-color: #ea4335; color: white; } 
        .use-btn:hover { background-color: #c93327; }

        .save-btn { background-color: #fbbc05; color: #333; margin-top: 15px; } 
        .save-btn:hover { background-color: #e5a800; }

        .export-btn { background-color: #1a73e8; color: white; } 
        .export-btn:hover { background-color: #155bb5; }

        .clear-btn { background-color: #6c757d; color: white; margin-left: 10px; }
        .clear-btn:hover { background-color: #5a6268; }

        .history-table th { background-color: #6c757d; }
        
        .alert-info {
            width: 100%; 
            padding: 12px;
            background-color: #e6f0ff; 
            border: 1px solid #cce0ff;
            color: #1a73e8;
            border-radius: 6px;
            margin-bottom: 25px;
            font-size: 0.9em;
        }
        /* Flex adjustments for horizontal layouts */
        .movement-controls {
            display: flex;
            flex-direction: column; 
            gap: 10px;
        }
        .movement-controls > * {
            width: 100%; 
            margin: 0;
        }
        .movement-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* History Header Controls */
        .history-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .history-header-controls h2 {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        /* Export Header Redesign for top corner placement (Section 4) */
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .export-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .export-controls label {
            font-weight: 500;
            color: #555;
        }
        /* Ensure wide sections take full width */
        .wide-section {
            flex-basis: 100%;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üéØ Professional Ink Stock Monitor & CSV Report (Qty)</h1>

    <p class="alert-info">
        **Note:** All data is stored locally in your browser's **Local Storage**. Ensure you use the **Save Minimum Levels** button to persist configuration changes.
    </p>

    <div class="section">
        <h2>1. Current Stock Status (Qty)</h2>
        <table id="currentStockTable">
            <thead>
                <tr>
                    <th>Ink Type</th>
                    <th>Stock (Qty)</th>
                    <th>Min Alert (Qty)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="stockTableBody">
                </tbody>
        </table>
        <button class="action-btn save-btn" onclick="saveStock()">üíæ Save Minimum Levels</button>
    </div>
    
    <div class="section">
        <h2>2. Record Stock Movement</h2>
        <div class="movement-controls">
            <select id="inkSelect">
                </select>
            
            <select id="printerSelect" onchange="updateMovementButtons()">
                <option value="">-- Select Printer/Location --</option>
                <option value="Printer 1">Printer 1</option>
                <option value="Printer 2">Printer 2</option>
                <option value="General Stock">General Stock (Stock In/Out)</option>
            </select>
            
            <input type="number" id="movementAmount" min="0" placeholder="Amount (Qty)">
            
            <input type="date" id="movementDate" value="">
            
            <div class="movement-buttons">
                <button class="action-btn add-btn" id="addBtn" onclick="addStock()">‚ûï Stock In</button>
                <button class="action-btn use-btn" id="useBtn" onclick="useStock()">‚ûñ Ink Used</button>
            </div>
        </div>
    </div>

    <div class="section wide-section">
        <div class="history-header-controls">
            <h2>3. History Log</h2>
            <div>
                <button class="action-btn export-btn" onclick="exportCurrentHistory()">‚¨áÔ∏è Export Log</button>
                <button class="action-btn clear-btn" onclick="clearHistory()">üßπ Clear History</button>
            </div>
        </div>
        
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Ink</th>
                    <th>Printer</th> 
                    <th>Operation</th>
                    <th>Amount (Qty)</th>
                </tr>
            </thead>
            <tbody id="historyTableBody">
                </tbody>
        </table>
    </div>
    
    <div class="section wide-section">
        <div class="export-header">
            <h2>4. Date Range Report Export</h2>
            <div class="export-controls">
                <label for="startDate">From:</label>
                <input type="date" id="startDate" required>
                
                <label for="endDate">To:</label>
                <input type="date" id="endDate" required>
                
                <button class="action-btn export-btn" onclick="exportCSV()">‚¨áÔ∏è Download Report</button>
            </div>
        </div>
        <p>This section allows you to export a CSV file filtered by a specific date range, while Section 3 exports the entire unfiltered log.</p>
    </div>
</div>

<script>
    const INITIAL_INKS = [
        { name: "Cyan", currentStock: 0, minLevel: 1 },
        { name: "Magenta", currentStock: 0, minLevel: 1 },
        { name: "Yellow", currentStock: 0, minLevel: 1 },
        { name: "Black", currentStock: 0, minLevel: 1 },
    ];

    // --- Data Load & Save Functions ---
    function loadStock() {
        const storedStock = localStorage.getItem('advancedInkStockQty'); 
        return storedStock ? JSON.parse(storedStock) : INITIAL_INKS;
    }

    function saveStock() {
        const currentStockData = getStockDataFromTable();
        const dataToSave = currentStockData.map(ink => ({
            name: ink.name,
            currentStock: ink.currentStock,
            minLevel: ink.minLevel 
        }));
        localStorage.setItem('advancedInkStockQty', JSON.stringify(dataToSave));
        alert("Minimum Stock Levels saved successfully!");
        renderStockTable(dataToSave); 
    }

    function loadHistory() {
        const storedHistory = localStorage.getItem('advancedInkHistoryQty'); 
        const history = storedHistory ? JSON.parse(storedHistory) : [];
        return history.slice().reverse(); 
    }

    function saveHistory(historyLog) {
        localStorage.setItem('advancedInkHistoryQty', JSON.stringify(historyLog));
    }

    // --- Rendering Functions ---
    function renderStockTable(inkData) {
        const tableBody = document.getElementById('stockTableBody');
        tableBody.innerHTML = '';
        const inkSelect = document.getElementById('inkSelect');
        inkSelect.innerHTML = '';

        inkData.forEach(ink => {
            const isLowStock = ink.currentStock < ink.minLevel;
            const row = tableBody.insertRow();
            row.className = isLowStock ? 'low-stock' : '';

            row.insertCell().textContent = ink.name;
            row.insertCell().textContent = Math.round(ink.currentStock * 100) / 100;
            
            const minCell = row.insertCell();
            const minInput = document.createElement('input');
            minInput.type = 'number';
            minInput.min = '0';
            minInput.value = ink.minLevel;
            minCell.appendChild(minInput);

            const statusCell = row.insertCell();
            statusCell.textContent = isLowStock ? "üí• Low Stock" : "‚úÖ Sufficient";
            statusCell.style.color = isLowStock ? '#c0392b' : '#34a853';

            const option = document.createElement('option');
            option.value = ink.name;
            option.textContent = ink.name;
            inkSelect.appendChild(option);
        });
    }

    function renderHistoryTable(historyData) {
        const tableBody = document.getElementById('historyTableBody');
        tableBody.innerHTML = '';

        historyData.forEach(log => {
            const row = tableBody.insertRow();
            row.insertCell().textContent = log.date;
            row.insertCell().textContent = log.ink;
            row.insertCell().textContent = log.printer || 'N/A'; 
            row.insertCell().textContent = log.type === 'ADD' ? 'Stock Added' : 'Stock Used';
            
            const amountCell = row.insertCell();
            const displayAmount = Math.round(log.amount * 100) / 100;
            amountCell.textContent = (log.type === 'ADD' ? '+' : '-') + displayAmount;
            amountCell.style.color = log.type === 'ADD' ? '#34a853' : '#ea4335';
        });
    }

    // --- Dynamic Button Control Function ---
    function updateMovementButtons() {
        const printerSelect = document.getElementById('printerSelect').value;
        const addBtn = document.getElementById('addBtn');
        const useBtn = document.getElementById('useBtn');

        if (printerSelect === 'General Stock') {
            addBtn.style.display = 'inline-block'; // Show Stock In
            useBtn.style.display = 'inline-block'; // Show Stock Used
        } else if (printerSelect === 'Printer 1' || printerSelect === 'Printer 2') {
            addBtn.style.display = 'none';        // Hide Stock In
            useBtn.style.display = 'inline-block'; // Show Stock Used
        } else {
            // Default: Hide both until ink and location are chosen
            addBtn.style.display = 'none';
            useBtn.style.display = 'none';
        }
    }

    // --- Data Handling Functions ---
    function getStockDataFromTable() {
        const rows = document.querySelectorAll('#stockTableBody tr');
        return Array.from(rows).map(row => {
            return {
                name: row.cells[0].textContent,
                currentStock: parseFloat(row.cells[1].textContent) || 0,
                minLevel: parseFloat(row.querySelector('input').value) || 0
            };
        });
    }
    
    function handleMovement(type) {
        const inkName = document.getElementById('inkSelect').value;
        const printerName = document.getElementById('printerSelect').value; 
        const amount = parseFloat(document.getElementById('movementAmount').value);
        const date = document.getElementById('movementDate').value;

        if (!inkName || !amount || amount <= 0 || !date) {
            alert("Please enter the Ink, Amount, and Date.");
            return;
        }

        if (type === 'USE' && !printerName) {
            alert("Please select the Printer/Location that used the ink.");
            return;
        }
        
        if (type === 'ADD' && printerName !== 'General Stock') {
            alert("Stock In operations must be logged against 'General Stock'.");
            return;
        }


        let currentStockData = loadStock();
        const inkIndex = currentStockData.findIndex(ink => ink.name === inkName);

        if (inkIndex === -1) return;

        if (type === 'USE' && currentStockData[inkIndex].currentStock < amount) {
            alert("‚ùå Insufficient Stock! Current Stock: " + currentStockData[inkIndex].currentStock.toFixed(2) + " Qty.");
            return;
        }

        if (type === 'ADD') {
            currentStockData[inkIndex].currentStock += amount;
        } else if (type === 'USE') {
            currentStockData[inkIndex].currentStock -= amount;
        }

        let historyLog = loadHistory().reverse();
        historyLog.push({
            date: date,
            ink: inkName,
            printer: type === 'USE' ? printerName : 'Stock In',
            type: type === 'ADD' ? 'ADD' : 'USE',
            amount: amount
        });

        localStorage.setItem('advancedInkStockQty', JSON.stringify(currentStockData));
        saveHistory(historyLog);

        renderStockTable(currentStockData);
        renderHistoryTable(loadHistory()); 
        
        document.getElementById('movementAmount').value = '';
        document.getElementById('movementDate').value = new Date().toISOString().substring(0, 10);
        document.getElementById('printerSelect').value = ''; 
        updateMovementButtons(); // Reset button visibility
    }

    function addStock() {
        handleMovement('ADD');
    }

    function useStock() {
        handleMovement('USE');
    }
    
    // --- Utility Export Function (used by both) ---
    function generateCSV(data, filename) {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Date,Ink Type,Printer/Stock Location,Operation,Amount (Qty)\n";

        data.forEach(log => {
            const operation = log.type === 'ADD' ? 'Stock Added' : 'Stock Used';
            const amount = (log.type === 'ADD' ? '+' : '-') + (Math.round(log.amount * 100) / 100);
            const printer = log.printer || 'N/A';

            const row = [log.date, log.ink, printer, operation, amount];
            csvContent += row.join(",") + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // --- Section 3: Export ALL History ---
    function exportCurrentHistory() {
        const historyLog = loadHistory().reverse(); 
        
        if (historyLog.length === 0) {
            alert("No transactions found to export.");
            return;
        }
        
        const today = new Date().toISOString().substring(0, 10);
        generateCSV(historyLog, `Ink_Log_Full_${today}.csv`);
    }

    // --- Section 3: Clear History ---
    function clearHistory() {
        if (confirm("‚ö†Ô∏è WARNING: This will permanently delete ALL recorded ink movements! Are you sure you want to proceed?")) {
            localStorage.removeItem('advancedInkHistoryQty');
            renderHistoryTable([]);
            alert("Ink history successfully cleared.");
        }
    }

    // --- Section 4: Export Date Range CSV ---
    function exportCSV() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
            alert("Please select both a Start Date and End Date for the report.");
            return;
        }
        
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (start > end) {
            alert("Start Date cannot be after End Date.");
            return;
        }

        const historyLog = loadHistory().reverse(); 
        
        const filteredData = historyLog.filter(log => {
            const logDate = new Date(log.date);
            const endOfDay = new Date(end);
            endOfDay.setHours(23, 59, 59, 999); 
            
            return logDate >= start && logDate <= endOfDay;
        });

        if (filteredData.length === 0) {
            alert("No transactions found within the selected date range.");
            return;
        }
        
        generateCSV(filteredData, `Ink_Stock_Report_${startDate}_to_${endDate}.csv`);
    }

    // --- Initialization ---
    function initialize() {
        const today = new Date().toISOString().substring(0, 10);
        document.getElementById('movementDate').value = today;
        document.getElementById('startDate').value = today; 
        document.getElementById('endDate').value = today; 
        
        const stockData = loadStock();
        renderStockTable(stockData);
        
        const historyData = loadHistory();
        renderHistoryTable(historyData);
        
        // Initial call to set button visibility
        updateMovementButtons(); 
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>

</body>
</html>